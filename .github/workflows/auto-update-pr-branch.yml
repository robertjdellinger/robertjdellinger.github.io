name: Auto-update PR branch

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, labeled]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: autoupdate-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  update:
    if: >
      github.event.pull_request.base.ref == 'main' ||
      github.event.pull_request.base.ref == 'netlify'
    runs-on: ubuntu-latest
    steps:
      - name: Only update internal PRs (skip forks)
        id: check_internal
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "external=true" >> $GITHUB_OUTPUT
          else
            echo "external=false" >> $GITHUB_OUTPUT
          fi
      - name: Update branch from base
        if: steps.check_internal.outputs.external == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.payload.pull_request.number;
            const base = context.payload.pull_request.base.ref;
            core.info(`Updating PR #${number} from base '${base}'...`);
            await github.rest.pulls.updateBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: number
            });
            core.info('Update requested successfully.')
